services:
  comfyui:
    # 1. 上記のDockerfileからイメージをビルドする場合
    # build: .
    # 2. 事前にビルドしたイメージや公開されているイメージを使う場合
    # image: your_username/comfyui-rocm:latest
    image: rocm/comfy_hnishi:latest
    
    container_name: comfyui_rocm
    
    # ポートマッピング: ホストの8188ポートをコンテナの8188ポートに接続
    ports:
      - '8188:8188'
      
    # ROCm/GPUへのアクセス設定（必須）
    devices:
      # メインのコンピュートインターフェース
      - /dev/kfd
      # Direct Rendering Interface (DRI)
      - /dev/dri
      
    # 永続化のためのボリュームマウント
    volumes:
      # ホストのモデル/設定フォルダをコンテナ内にマウント
      # ホスト側: ~/comfy_data/models/checkpoints (Stable Diffusionモデル)
      # コンテナ側: /app/ComfyUI/models/checkpoints
      - ${HOME}/workdir/rocm/comfy_data/models/checkpoints:/app/ComfyUI/models/checkpoints
      
      # ホストの出力フォルダをコンテナ内にマウント
      # - ${HOME}/workdir/rocm/comfy_data/output:/app/ComfyUI/output
      
      # カスタムノードの管理
      # - ${HOME}/workdir/rocm/comfy_data/custom_nodes:/app/ComfyUI/custom_nodes

    # 8700G (gfx1103) のプレビューサポートに推奨される環境変数
    environment:
      # Ryzen 7 8700G (Rembrandt) ではエラーになるので、RDNA3を指定する
      # - HSA_OVERRIDE_GFX_VERSION=11.0.3
      HSA_OVERRIDE_GFX_VERSION: "11.0.0"
      # PyTorchの最適化オプション
      TORCH_COMMAND_LINE: "--opt-sdp-attention"
      # VRAM不足時のための設定（任意）
      PYTORCH_HIP_ALLOC_CONF: "garbage_collection_threshold:0.9,max_split_size_mb:512"
    
    # 起動時の実行コマンド (docker run の末尾のコマンドに相当)
    # これにより、ComfyUIが指定されたオプションで起動されます。
    command: 
      [
        "python3", 
        "/app/ComfyUI/main.py", 
        "--listen", "0.0.0.0", 
        "--port", "8188", 
        "--lowvram", 
        "--cpu-vae"
      ]
    
    # デタッチモード (docker run -d に相当)
    # docker compose up で起動する際に -d オプションを指定すれば不要ですが、
    # ここで設定することで、コンテナが予期せず終了した際に再起動させることも可能です。
    # restart: unless-stopped
    
    # TTY割り当てと標準入出力の保持 (docker run -it に相当)
    # 通常、-d (デタッチモード)と組み合わせて使用されるため、
    # docker-composeではこの記述は省略されることが多いですが、必要に応じて含めます。
    # tty: true
    # stdin_open: true